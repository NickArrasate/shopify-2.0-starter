{% comment %}
After adding this file as a snippet, make sure to include it in the theme with the following: {% render 'cookie-monster' %}
{% endcomment %}
<script>
(async () => {
    window.ViaTrackerToken = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJob3N0bmFtZSI6Ind3dy5pY2VsYW50aWNza2lzLmNvbSIsImxvY2F0aW9uSWQiOiI2MTUxZWQ4ODU3Mjg4ZDAyMzY2MTRlMGQiLCJpYXQiOjE2NDg4Mjg5MjN9.NtYil22nj3no-t3p3k1pFMYMkUbVslr4uEyA6vyLtTaFVdKPJSxu3_J96RwGgDkPrtFgRI274zKEyGROsPp6a69IPEDdLLDRQij1gsB_ckeKMH3kCAtWU4z4jNctEskwP7tCo99d8rAvCo5C4rkmZuZkMt7AbKPR56i_9CfsxNw';
    window.ViaStoreType = 'shopify';

    const BASE_URL = 'https://api.viacustomers.com';

    const utcDate = (date) => new Date(date).toUTCString();

    const COOKIE_DELIMITER = '; ';
    const PAIR_DELIMITER = '=';
    const MAX_DATE = new Date('+275760-09-13T00:00:00Z');

    const cookies = {
        get items() {
            const decodedCookie = decodeURIComponent(document.cookie);
            const pairs = decodedCookie.split(COOKIE_DELIMITER).map((cookie) => cookie.split(PAIR_DELIMITER));
            return Object.fromEntries(pairs);
        },
        get length() {
            return Object.keys(this.items).length;
        },
        getItem(key) {
            return this.items[key] || null;
        },
        setItem(key, value, { expires, maxAge, path = '/', domain } = {}) {
            const config = {
                [key]: value,
                domain,
                path,
                'max-age': maxAge, // renamed
                'expires': expires !== undefined ? utcDate(expires) : null,
            };
    
            const cookie = Object.entries(config)
                .filter(([, value]) => value !== undefined)
                .map(([key, value]) => `${key}${PAIR_DELIMITER}${value}`)
                .join(COOKIE_DELIMITER);
    
            document.cookie = cookie;
        },
        removeItem(key, { path = '/', domain } = {}) {
            this.setItem(key, null, { expires: 0, path, domain });
        },
    };

    const viaStorage = {
        key: {
            customerId: '_viaCustomerId',
            userId: '_viaUserId',
        },
        get customerId() {
            return cookies.getItem(this.key.customerId);
        },
        set customerId(value) {
            cookies.setItem(this.key.customerId, value);
        },

        get userId() {
            return cookies.getItem(this.key.userId);
        },
        set userId(value) {
            cookies.setItem(this.key.userId, value, { expires: MAX_DATE });
        },
    };

    function addParametersToURL(url, pairs) {
        const parameters = Object.entries(pairs)
            .filter(([key, value]) => value !== undefined) // clean parameters
            .map(([key, value]) => `${key}=${encodeURIComponent(value)}`) // encode pairs
            .join('&');
        return `${url}${url.includes('?') ? '&' : '?'}${parameters}`;
    }

    async function getViaCustomerId(shopifyCustomerId, phone, email) {
        let url = `${BASE_URL}/api/v2/customers/get_or_create`;
        const parameters = { shopifyId: shopifyCustomerId, phone, email };
        url = addParametersToURL(url, parameters);

        return fetch(url, {
            headers: {
                'Authorization': `Bearer ${window['ViaTrackerToken']}`,
                'Content-Type': 'application/json',
            },
            method: 'GET',
        }).then((response) => response.json());
    }

    async function customerViewedProduct(viaCustomerId, storeType, productId, variantId) {
        let url = `${BASE_URL}/api/v2/customers/product_viewed`;
        const parameters = { customerId: viaCustomerId, productId, variantId, storeType };
        url = addParametersToURL(url, parameters);

        return fetch(url, {
            headers: {
                'Authorization': `Bearer ${window['ViaTrackerToken']}`,
                'Content-Type': 'application/json',
            },
            method: 'GET',
        });
    }

    function checkStorageUsers() {
        // userId MIGHT be set by popups
        if (viaStorage.customerId) return;
        if (!viaStorage.userId) return;
        viaStorage.customerId = viaStorage.userId;
    }

    async function identifyViaCustomer() {
        {% if customer %}
            if (viaStorage.customerId) return;
            let email = '';
            let phone = '';
            const shopifyCustomerId = {{customer.id | json }};

            {% if customer.email %}
                email = {{ customer.email | json }};
            {% endif %}

            {% if customer.phone %}
                phone = {{ customer.phone | json }};
            {% endif %}
            const { id } = await getViaCustomerId(shopifyCustomerId, phone, email);
            if (id) viaStorage.customerId = id;

        {% endif %}
    }

    async function track() {
        if (!viaStorage.customerId) return;
        // undefined will be omitted from request query string parameters
        let productId = undefined;
        let variantId = undefined;

        {% if product %}
            productId = {{ product.id | json }};
            {% if variant %}
                variantId = {{ variant.id | json }};
            {% endif %}
            const storeType = window['ViaStoreType'];
            await customerViewedProduct(viaStorage.customerId, storeType, productId, variantId);
        {% endif %}
    }

    checkStorageUsers();
    await identifyViaCustomer();
    await track();
})();
</script>